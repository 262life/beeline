name: release
on:
  push:
    tags:
    - "v[0-9]+.[1-9]+.[0-9]*"
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - run: |
          export POSTFIX=" (Codename: '$(cat CODENAME)')"
          echo "::set-env name=RELEASE_NAME_POSTFIX::$POSTFIX"
      - name: Set Version
        run: |
          export RELEASE_VERSION=$(echo $GITHUB_REF | awk -F\/ '{print $3}')
          echo "::set-env name=RELEASE_VERSION::$RELEASE_VERSION"
          echo "Release Version is $RELEASE_VERSION"
          echo "$RELEASE_VERSION" > VERSION
          if echo "$RELEASE_VERSION" | grep "rc" > /dev/null ; then
            echo "::set-env name=RELEASE_PRE::true"
            echo "::set-env name=RELEASE_LATEST::false"
          else
            echo "::set-env name=RELEASE_PRE::false"
            echo "::set-env name=RELEASE_LATEST::true"
          fi  
      - name: Build Version
        run: |
          bash -c "chmod 755 .github/scripts/plugins.sh; .github/scripts/version.sh"
      - name: Release
        uses: docker://antonyurchenko/git-release:latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_FILE: "changes.md"
          DRAFT_RELEASE: "false"
          PRE_RELEASE: "${{ env.RELEASE_PRE }}"
          ALLOW_EMPTY_CHANGELOG: "false"
          ALLOW_TAG_PREFIX: "true"
        with:
          args: |
            k8s_shortcuts
      - id: get_latest_version
        uses: pozetroninc/github-action-get-latest-release@master
        with:
            repository: BobDotMe/k8s_shortcuts
      - name: Set Latest Version
        run: |    
          echo "${{ steps.get_latest_version.outputs.release }}"" > LATEST_VERSION
      - name: Create Version
        run: |
          bash -c "chmod 755 .github/scripts/readme.sh; .github/scripts/readme.sh"
          bash -c "chmod 755 .github/scripts/docs.sh; .github/scripts/docs.sh"
      - name: push
        uses: github-actions-x/commit@v2.6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-branch: 'master'
          commit-message: 'publish'
          force-add: 'true'
          files:  README.md LATEST_VERSION VERSION 
          name: rsliotta
          email: bob@bobdot.me
